
{% block content %}
<div class="container py-4">
  <h3>Referral Review — REF{{ r.id }}</h3>
  {% if messages %}{% for m in messages %}<div class="alert alert-{{ m.tags }}">{{ m }}</div>{% endfor %}{% endif %}
  <div class="card p-3 mb-3">
    <div class="row">
      <div class="col-md-8">
       
        <p><strong>Referral Type:</strong> {{ r.get_referral_type_display }}</p>
        <p><strong>Referred:</strong> {{ r.referred_name }} — {{ r.referred_phone }} {% if r.referred_email %} — {{ r.referred_email }}{% endif %}</p>
        <p><strong>Referral Value:</strong> {% if r.referral_value %}₹{{ r.referral_value }}{% else %}—{% endif %}</p>
        <p><strong>Description:</strong> {{ r.description }}</p>
        <p><strong>Uploaded Document:</strong>
          {% if r.document %}
            <a href="{{ r.document.url }}" target="_blank">View Document</a>
          {% else %}None{% endif %}
        </p>
      </div>
      <div class="col-md-4">
        <p><strong>Submitted:</strong> {{ r.created_at|date:"Y-m-d H:i" }}</p>
        <p><strong>Status:</strong> {{ r.status }}</p>
        <p><strong>Admin Remarks:</strong> {{ r.admin_remarks|default:"—" }}</p>
      </div>
    </div>
  </div>

  <form method="post" class="card p-3" id="reviewForm">
    {% csrf_token %}
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Commission Amount (₹)</label>
        <input id="commission_amount" name="commission_amount" class="form-control" value="{{ r.commission_amount|default:default_commission }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Tax (%)</label>
        <input id="tax_percent" class="form-control" value="10.00" readonly>
      </div>

      <div class="col-md-3">
        <label class="form-label">Tax Amount (₹)</label>
        <input id="tax_amount" class="form-control" readonly value="{{ default_tax }}">
      </div>

      <div class="col-md-3">
        <label class="form-label">Final Commission (₹)</label>
        <input id="final_commission" class="form-control" readonly value="{{ default_final }}">
      </div>

      <div class="col-12">
        <label class="form-label">Admin Remarks</label>
        <textarea name="admin_remarks" class="form-control" rows="2">{{ r.admin_remarks }}</textarea>
      </div>

      <div class="col-md-3 form-check mt-2">
        <input class="form-check-input" type="checkbox" name="wallet_update" id="wallet_update" checked>
        <label class="form-check-label" for="wallet_update">Wallet Update?</label>
      </div>

      <div class="col-12 text-end">
        <button class="btn btn-danger" type="submit" name="action" value="reject">Reject Request</button>
        <button class="btn btn-success" type="submit" name="action" value="approve">Approve &amp; Update Wallet</button>
      </div>
    </div>
  </form>

  {% if r.closing_report %}
  <div class="mt-3">
    <a href="{% url 'referrals:download_closing_report' r.id %}" class="btn btn-outline-primary">Download Closing Report</a>
  </div>
  {% endif %}
</div>

<script>
  // live calculation on client-side
  (function(){
    const commInput = document.getElementById('commission_amount');
    const taxPercent = parseFloat(document.getElementById('tax_percent').value || "10");
    const taxAmount = document.getElementById('tax_amount');
    const final = document.getElementById('final_commission');

    function recalc(){
      let c = parseFloat(commInput.value || 0);
      if (isNaN(c)) c = 0;
      const tax = +(c * taxPercent / 100).toFixed(2);
      const fin = +(c - tax).toFixed(2);
      taxAmount.value = tax.toFixed(2);
      final.value = fin.toFixed(2);
    }
    commInput.addEventListener('input', recalc);
    recalc();
  })();
</script>
{% endblock %}
