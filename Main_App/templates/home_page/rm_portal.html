{% load static %}
{% block title %}RM Portal Dashboard{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { background-color: #f5f6fa; font-family: 'Inter', sans-serif; }
  .dashboard-header { background: linear-gradient(90deg, #007bff, #00b894); color: #fff; border-radius: 12px; padding: 25px 30px; }
  .dashboard-header h3 { font-weight: 600; }
  .dashboard-header small { opacity: 0.9; }
  .action-btns a { border-radius: 30px; font-weight: 500; }
  .card { border: none; border-radius: 12px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
  .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
  .table thead { background: #f8f9fa; }
  .badge { font-size: 0.8rem; }
</style>

<div class="container my-4">
  <!-- Header -->
  <div class="dashboard-header d-flex flex-wrap justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-1">Hello, {{ rm_profile.user.get_full_name }}</h3>
      <small>Role: {{ rm_profile.role|title }} ‚Ä¢ Zone: {{ rm_profile.zone|default:"N/A" }}</small>
    </div>
    <div class="action-btns mt-3 mt-md-0">
      <a href="#" class="btn btn-light me-2 text-primary"><i class="bi bi-plus-circle"></i> Record Service</a>
      <a href="#" class="btn btn-light me-2 text-success"><i class="bi bi-wallet2"></i> Request Payout</a>
      <a href="#" class="btn btn-outline-light"><i class="bi bi-arrow-clockwise"></i> Refresh</a>
    </div>
  </div>

  <!-- Earnings Cards -->

  <div class="row g-3 mb-4">
    <div class="col-sm-6 col-lg-3">
      <div class="card shadow-sm text-center bg-white p-3">
        <div class="card-body">
          <small class="text-muted">Service Income</small>
          <h4 class="mt-2 fw-bold text-primary">‚Çπ{{ total_service_income|default:"0.00" }}</h4>
          <small class="text-success">Updated: {{ now|date:"d M Y" }}</small>
        </div>
      </div>
    </div>

```
<div class="col-sm-6 col-lg-3">
  <div class="card shadow-sm text-center bg-white p-3">
    <div class="card-body">
      <small class="text-muted">Referral Income</small>
      <h4 class="mt-2 fw-bold text-success">‚Çπ{{ total_referral_income|default:"0.00" }}</h4>
      <small class="text-muted">Referrals: {{ rm_profile.referrals_made.count }}</small>
    </div>
  </div>
</div>

<div class="col-sm-6 col-lg-3">
  <div class="card shadow-sm text-center bg-white p-3">
    <div class="card-body">
      <small class="text-muted">Pending Payouts</small>
      <h4 class="mt-2 fw-bold text-warning">‚Çπ{% with pending=payouts|dictsortreversed:"requested_at"|first %}{% if pending %}{{ pending.amount }}{% else %}0.00{% endif %}{% endwith %}</h4>
      <small class="text-muted">Requests: {{ payouts.count }}</small>
    </div>
  </div>
</div>

<div class="col-sm-6 col-lg-3">
  <div class="card shadow-sm text-center bg-white p-3">
    <div class="card-body">
      <small class="text-muted">Total Income</small>
      <h4 class="mt-2 fw-bold text-dark">‚Çπ{{ total_income|default:"0.00" }}</h4>
      <small class="text-muted">Active since {{ rm_profile.created_at|date:"M Y" }}</small>
    </div>
  </div>
</div>
```

  </div>

  <div class="row">
    <!-- Left Column -->
    <div class="col-lg-7">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="card-title fw-semibold text-primary">üìä Monthly Earnings</h5>
          <canvas id="earningsChart" style="max-height:320px;"></canvas>
          <small class="form-text text-muted mt-2">Monthly commission trend ‚Äî auto-updated.</small>
        </div>
      </div>

```
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title fw-semibold text-primary">üíº Recent Service Transactions</h5>
      <div class="table-responsive mt-3">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Service</th><th>Fee (‚Çπ)</th><th>Commission (‚Çπ)</th><th>Status</th><th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for s in services|slice:":10" %}
            <tr>
              <td>{{ s.id }}</td>
              <td>{{ s.get_service_type_display }}</td>
              <td>‚Çπ{{ s.service_fee }}</td>
              <td>‚Çπ{{ s.commission_amount }}</td>
              <td>
                {% if s.status == "Pending" %}
                  <span class="badge bg-warning text-dark">Pending</span>
                {% elif s.status == "Approved" %}
                  <span class="badge bg-info">Approved</span>
                {% elif s.status == "Paid" %}
                  <span class="badge bg-success">Paid</span>
                {% else %}
                  <span class="badge bg-secondary">{{ s.status }}</span>
                {% endif %}
              </td>
              <td>{{ s.created_at|date:"d M Y" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-center text-muted">No transactions yet</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="text-end mt-2">
        <a href="#" class="btn btn-sm btn-outline-primary">Add New Service</a>
      </div>
    </div>
  </div>
</div>

<!-- Right Column -->
<div class="col-lg-5">
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <h5 class="card-title fw-semibold text-success">ü§ù Refer & Earn</h5>
      <form method="post" action="">
        {% csrf_token %}
        <div class="mb-2"><label class="form-label">Name</label><input name="referred_name" class="form-control" required placeholder="Referred person name"></div>
        <div class="mb-2"><label class="form-label">Phone</label><input name="referred_phone" class="form-control" required placeholder="Phone number"></div>
        <div class="mb-2"><label class="form-label">Email</label><input name="referred_email" class="form-control" placeholder="Email (optional)"></div>
        <div class="mb-2">
          <label class="form-label">Type</label>
          <select name="referral_type" class="form-select">
            <option value="RM">New RM</option>
            <option value="Owner">Property Owner</option>
            <option value="Tenant">Tenant</option>
          </select>
        </div>
        <button class="btn btn-success w-100 mt-2" type="submit">Submit Referral (Earn ‚Çπ300)</button>
      </form>

      <hr>

      <h6 class="fw-semibold mt-3">Quick Actions</h6>
      <div class="d-grid gap-2 mt-2">
        <a href="#" class="btn btn-outline-success">Request Payout</a>
        <a href="#" class="btn btn-outline-secondary">View Full Dashboard</a>
        <a href="#" class="btn btn-outline-primary">Export My Payouts (Admin only)</a>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title fw-semibold text-primary">‚ö° Quick Add-on Sale</h5>
      <form method="post" action="">
        {% csrf_token %}
        <div class="mb-2"><label class="form-label small">Service</label>
          <select name="service_type" class="form-select" required>
            <option value="verified_listing">Verified Listing</option>
            <option value="rent_agreement">Rent Agreement</option>
            <option value="movers_packers">Movers & Packers</option>
            <option value="police_verification">Police Verification</option>
            <option value="featured_property">Featured Property</option>
          </select>
        </div>
        <div class="mb-2"><label class="form-label small">Fee (‚Çπ)</label>
          <input name="service_fee" class="form-control" type="number" step="0.01" required placeholder="Service fee">
        </div>
        <button class="btn btn-primary w-100">Record Sale</button>
      </form>
    </div>
  </div>
</div>
```

  </div>

  <!-- Payout History -->

  <div class="card mt-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title fw-semibold text-primary">üí∞ Payout Requests</h5>
      <div class="table-responsive mt-3">
        <table class="table table-sm align-middle">
          <thead class="table-light"><tr><th>ID</th><th>Amount (‚Çπ)</th><th>Requested At</th><th>Status</th></tr></thead>
          <tbody>
            {% for p in payouts %}
            <tr>
              <td>{{ p.id }}</td>
              <td>‚Çπ{{ p.amount }}</td>
              <td>{{ p.requested_at|date:"d M Y" }}</td>
              <td>
                {% if p.status == "Requested" %}<span class="badge bg-warning text-dark">Requested</span>
                {% elif p.status == "Approved" %}<span class="badge bg-info">Approved</span>
                {% elif p.status == "Paid" %}<span class="badge bg-success">Paid</span>
                {% else %}<span class="badge bg-secondary">{{ p.status }}</span>{% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="text-center text-muted">No payout requests found</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const rmId = {{ rm_profile.id }};
  const ctx = document.getElementById('earningsChart').getContext('2d');

  async function fetchChartData() {
    try {
      const resp = await fetch(`/admin/rm-performance-data/${rmId}/`);
      if (!resp.ok) throw new Error('Failed to fetch');
      const data = await resp.json();
      const labels = data.map(d => new Date(d.month).toLocaleString('default', { month: 'short', year: 'numeric' }));
      const values = data.map(d => Number(d.total_commission || 0));

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels.length ? labels : ['No Data'],
          datasets: [{
            label: 'Monthly Earnings (‚Çπ)',
            data: values.length ? values : [0],
            backgroundColor: 'rgba(0, 123, 255, 0.6)',
            borderColor: '#007bff',
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    } catch (err) { console.error(err); }
  }
  fetchChartData();
});
</script>

{% endblock %}
