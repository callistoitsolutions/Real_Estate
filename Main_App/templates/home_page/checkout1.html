<!doctype html>
<html>
<head>
  <title>Checkout - {{ plan.name }}</title>
  <script>
    // front-end dynamic calculation: will request pricing from the page values (simple)
    function calcTotal() {
      // base price logic: for demo we simply pick first matching plan service by duration
      var dur = document.querySelector('select[name="duration"]').value;
      var base = 0.0;
      var rows = document.querySelectorAll('.psrow');
      for (var i=0;i<rows.length;i++){
        if (rows[i].dataset.duration == dur){
          base += parseFloat(rows[i].dataset.price);
        }
      }
      var addonTotal = 0.0;
      var addons = document.querySelectorAll('input[name="addons[]"]:checked');
      for (var i=0;i<addons.length;i++){
        addonTotal += parseFloat(addons[i].dataset.price);
      }
      var total = base + addonTotal;
      document.getElementById('total_span').innerText = total.toFixed(2);
      document.getElementById('hidden_total').value = total.toFixed(2);
    }
  </script>
</head>
<body onload="calcTotal()">
  <h2>Checkout - {{ plan.name }}</h2>

  <form method="post">
    {% csrf_token %}
    <label>Your Name</label><br>
    <input type="text" name="purchaser_name" required><br>
    <label>Email</label><br>
    <input type="email" name="purchaser_email" required><br>

    <label>Duration</label><br>
    <select name="duration" onchange="calcTotal()">
      <option value="1M">1 Month</option>
      <option value="3M">3 Months</option>
      <option value="6M">6 Months</option>
      <option value="1Y">1 Year</option>
    </select><br>

    <h4>Included Plan Services (for dynamic price calculation)</h4>
    <div>
      {% for ps in plan_services %}
        <div class="psrow" data-duration="{{ ps.duration }}" data-price="{{ ps.final_price }}">
          {{ ps.service.name }} — {{ ps.get_duration_display }} — ₹{{ ps.final_price }}
        </div>
      {% endfor %}
    </div>

    <h4>Add-ons</h4>
    {% for ao in addons %}
      <div>
        <input type="checkbox" name="addons[]" value="{{ ao.id }}" data-price="{{ ao.price }}" onchange="calcTotal()">
        {{ ao.name }} — ₹{{ ao.price }}
      </div>
    {% endfor %}

    <h3>Total: ₹<span id="total_span">0.00</span></h3>
    <input type="hidden" name="computed_total" id="hidden_total" value="0.00">

    <button type="submit">Pay Now (Simulated)</button>
  </form>
</body>
</html>
