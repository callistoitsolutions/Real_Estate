{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin - Enquiries</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h3>Admin — Enquiries</h3>

    <div id="list">
      {% for e in enquiries %}
      <div class="card mb-2 p-3">
        <div class="d-flex justify-content-between">
          <div><strong>{{ e.enquiry_id }}</strong> — {{ e.service }} • {{ e.city }}</div>
          <div>Status: {{ e.status }}</div>
        </div>
        <div class="mt-2">{{ e.details|truncatechars:200 }}</div>
        <div class="mt-2">
          Shared: {{ e.shared_vendors|join:", " }}
          {% if e.assigned_vendor %} • Assigned: {{ e.assigned_vendor.business_name }} {% endif %}
        </div>
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-success" onclick="autoAssign('{{ e.enquiry_id }}')">Auto-Assign</button>
          <button class="btn btn-sm btn-outline-primary" onclick="manualAssignPrompt('{{ e.enquiry_id }}')">Manual Assign</button>
          <a href="{% url 'vendors_module:enquiry_detail' e.enquiry_id %}" class="btn btn-sm btn-outline-secondary">Details</a>
        </div>
      </div>
      {% empty %}
      <div class="alert alert-info">No enquiries</div>
      {% endfor %}
    </div>

  </div>

<script>
function getCSRF(){ return document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''; }
async function autoAssign(enqId){
  const res = await fetch(`/vendors_module/enquiry/${enqId}/auto_assign/`, {method:'POST', headers:{'X-CSRFToken':getCSRF()}});
  const data = await res.json();
  alert(JSON.stringify(data));
  location.reload();
}
function manualAssignPrompt(enqId){
  const vid = prompt('Enter vendor id to assign');
  if(!vid) return;
  fetch(`/vendors_module/enquiry/${enqId}/manual_assign/`, {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':getCSRF()},
    body: JSON.stringify({vendor_id: vid})
  }).then(r=>r.json()).then(d=>{
    alert(JSON.stringify(d)); location.reload();
  });
}
</script>
</body>
</html>
